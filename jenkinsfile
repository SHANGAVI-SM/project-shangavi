pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // Checkout the source code from the Git repository
                script {
                    sh 'git checkout dev'
                    sh 'git pull origin dev'
                }
            }
        }

        stage('Build and Push to dev repo') {
            when {
                expression { currentBuild.rawBuild.getChangeSets().size() > 0 }
            }
            steps {
                script {
                    // Define variables for Docker image information
                    def dockerImageName = 'capstoneimage'
                    def dockerImageTag = 'latest'
                    def dockerHubRegistry = 'docker.io'
                    def dockerHubRepository = 'shangavism/dev'

                    // Build and tag the Docker image
                    sh "docker build -t ${dockerImageName}:${dockerImageTag} ."

                    // Log in to Docker Hub (you may need to provide credentials)
                    withCredentials([usernamePassword(credentialsId: 'your-docker-hub-credentials', usernameVariable: 'DOCKER_HUB_USERNAME', passwordVariable: 'DOCKER_HUB_PASSWORD')]) {
                        sh "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD"
                    }

                    // Push the Docker image to the development repository on Docker Hub
                    sh "docker tag ${dockerImageName}:${dockerImageTag} ${dockerHubRegistry}/${dockerHubRepository}:${dockerImageTag}"
                    sh "docker push ${dockerHubRegistry}/${dockerHubRepository}:${dockerImageTag}"
                }
            }
        }

        stage('Push to Prod Repo') {
            when {
                expression { currentBuild.rawBuild.getChangeSets().size() > 0 }
            }
            steps {
                script {
                    // Define variables for the production Docker image
                    def prodDockerImageTag = 'prod'
                    def prodDockerHubRepository = 'shangavism/prod'
                   
                    // Checkout the 'master' branch
                    sh 'git checkout master'
                    sh 'git pull origin master'

                    // Tag the Docker image for production
                    sh "docker tag ${dockerImageName}:${dockerImageTag} ${dockerHubRegistry}/${prodDockerHubRepository}:${prodDockerImageTag}"

                    // Push the Docker image to the production repository on Docker Hub
                    sh "docker push ${dockerHubRegistry}/${prodDockerHubRepository}:${prodDockerImageTag}"
                }
            }
        }
        stage('deploy the application' ) {
            steps {
                script {
                    // define variable for deploying the application         
                    def awsEC2InstanceIP = '43.205.110.72'
            
                    // Pull the Docker image from the production repository on Docker Hub
                    sh "docker pull ${dockerHubRegistry}/${prodDockerHubRepository}:${prodDockerImageTag}"

                    // Deploy the application to your AWS server
                    sh "docker run -d -p 80:80 --name my-app ${dockerHubRegistry}/${prodDockerHubRepository}:${prodDockerImageTag}"
                }
            }
        }
    }
}
